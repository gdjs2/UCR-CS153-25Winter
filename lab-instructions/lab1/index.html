
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lab Session for CS153 Design of Operating System">
      
      
        <meta name="author" content="Zhaoqi Xiao">
      
      
        <link rel="canonical" href="http://gdjs2.cn/UCR-CS153-25Winter/lab-instructions/lab1/">
      
      
        <link rel="prev" href="../lab0/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>Lab 1 - System Call - CS153 Design of Operating System - Lab Session</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-1-system-call" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CS153 Design of Operating System - Lab Session" class="md-header__button md-logo" aria-label="CS153 Design of Operating System - Lab Session" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CS153 Design of Operating System - Lab Session
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 1 - System Call
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CS153 Design of Operating System - Lab Session" class="md-nav__button md-logo" aria-label="CS153 Design of Operating System - Lab Session" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    CS153 Design of Operating System - Lab Session
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CS153 - Design of Operating System - Lab Session - 25 Winter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Lab instructions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Lab instructions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../c-pointers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to C language and Pointers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 0 Instructions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lab 1 - System Call
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lab 1 - System Call
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#accept-your-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      Accept Your Assignment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-system-call" class="md-nav__link">
    <span class="md-ellipsis">
      What is system call?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-does-system-call-work" class="md-nav__link">
    <span class="md-ellipsis">
      How does system call work?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#your-task" class="md-nav__link">
    <span class="md-ellipsis">
      Your Task
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instruction" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Instruction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grading-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Grading Policy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-to-write-in-report" class="md-nav__link">
    <span class="md-ellipsis">
      What to write in report
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-program" class="md-nav__link">
    <span class="md-ellipsis">
      Test Program
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#accept-your-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      Accept Your Assignment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-system-call" class="md-nav__link">
    <span class="md-ellipsis">
      What is system call?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-does-system-call-work" class="md-nav__link">
    <span class="md-ellipsis">
      How does system call work?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#your-task" class="md-nav__link">
    <span class="md-ellipsis">
      Your Task
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instruction" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Instruction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grading-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Grading Policy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-to-write-in-report" class="md-nav__link">
    <span class="md-ellipsis">
      What to write in report
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-program" class="md-nav__link">
    <span class="md-ellipsis">
      Test Program
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="lab-1-system-call">Lab 1 - System Call</h1>
<h2 id="accept-your-assignment">Accept Your Assignment</h2>
<p><a href="https://classroom.github.com/a/c8VO7Hjn">https://classroom.github.com/a/c8VO7Hjn</a></p>
<p><strong>Due: Sunday, Feb 2nd, 2025, 23:59, PST</strong></p>
<h2 id="background">Background</h2>
<h3 id="what-is-system-call">What is system call?</h3>
<p>A system call is a way for programs to interact with the operating system. It provides an interface between a process and the operating system, allowing the process to request high-privilege services such as file operatios, process control and communication. </p>
<p>Because it involves two parties - the user program (low privilege) and the operating system (high privilege), it is bound to have a transition of privileges. </p>
<h3 id="how-does-system-call-work">How does system call work?</h3>
<p>You can call a system call (e.g., exit(), which is used for terminating current program) in a user space program (like in our hello-world.c program). Let's just use our hello-world program and change it a little bit.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// hello-world.c in /user/</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel/types.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;user/user.h&quot;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello, world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;?.? Dead code ?.?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Also, we need to add a line in the <code>Makefile</code>. This modification adds a user space program, making program <code>make</code> know that it should compile the program <code>hello-world.c</code> under <code>/user/</code>. <code>$U</code> stands for <code>/user/</code> directory. </p>
<blockquote>
<p>What is user space program and what is kernel space program? If you take a look at the codebase of xv6, you may find there are two major directories, <code>/user/</code> and <code>/kernel/</code>. All the things in <code>/kernel</code> directory is kernel space program/code and the so for <code>/user</code>. However, there are much more different things between them. You can learn more from <a href="https://en.wikipedia.org/wiki/User_space_and_kernel_space#:~:text=Kernel%20space%20is%20strictly%20reserved,one%20address%20space%20per%20process.">wiki</a></p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="err">...</span><span class="w"> </span><span class="err">line</span><span class="w"> </span><span class="err">138</span>
<span class="w">    </span><span class="err">$U/_grind\</span>
<span class="w">    </span><span class="err">$U/_wc\</span>
<span class="w">    </span><span class="err">$U/_zombie\</span>
<span class="w">    </span><span class="err">$U/_hello-world\</span>
</code></pre></div></td></tr></table></div>
<p>Let's compile this file and see what will happen. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>make<span class="w"> </span>qemu
riscv64-linux-gnu-gcc<span class="w">    </span>-c<span class="w"> </span>-o<span class="w"> </span>kernel/entry.o<span class="w"> </span>kernel/entry.S
...
xv6<span class="w"> </span>kernel<span class="w"> </span>is<span class="w"> </span>booting

hart<span class="w"> </span><span class="m">2</span><span class="w"> </span>starting
hart<span class="w"> </span><span class="m">1</span><span class="w"> </span>starting
init:<span class="w"> </span>starting<span class="w"> </span>sh
$<span class="w"> </span>
</code></pre></div></td></tr></table></div>
<p>Then use <code>ls</code> command listing all available programs in user space. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>ls
.<span class="w">              </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1024</span>
..<span class="w">             </span><span class="m">1</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">1024</span>
README<span class="w">         </span><span class="m">2</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">2292</span>
cat<span class="w">            </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="m">34256</span>
<span class="nb">echo</span><span class="w">           </span><span class="m">2</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="m">33184</span>
forktest<span class="w">       </span><span class="m">2</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">16168</span>
grep<span class="w">           </span><span class="m">2</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">37520</span>
init<span class="w">           </span><span class="m">2</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">33640</span>
<span class="nb">kill</span><span class="w">           </span><span class="m">2</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="m">33096</span>
ln<span class="w">             </span><span class="m">2</span><span class="w"> </span><span class="m">9</span><span class="w"> </span><span class="m">32912</span>
ls<span class="w">             </span><span class="m">2</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">36280</span>
mkdir<span class="w">          </span><span class="m">2</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">33152</span>
rm<span class="w">             </span><span class="m">2</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">33144</span>
sh<span class="w">             </span><span class="m">2</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">54720</span>
stressfs<span class="w">       </span><span class="m">2</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">34040</span>
usertests<span class="w">      </span><span class="m">2</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="m">179344</span>
grind<span class="w">          </span><span class="m">2</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="m">49392</span>
wc<span class="w">             </span><span class="m">2</span><span class="w"> </span><span class="m">17</span><span class="w"> </span><span class="m">35216</span>
zombie<span class="w">         </span><span class="m">2</span><span class="w"> </span><span class="m">18</span><span class="w"> </span><span class="m">32520</span>
hello-world<span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">19</span><span class="w"> </span><span class="m">32656</span>
console<span class="w">        </span><span class="m">3</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="m">0</span>
</code></pre></div></td></tr></table></div>
<p>We can check there is a hello-world program. Then we can execute it by:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>hello-world
Hello,<span class="w"> </span>world!
</code></pre></div></td></tr></table></div></p>
<p>What happened? The code after <code>exit(0)</code> is just ignored. The reason for this is the program just exits at <code>exit(0)</code> and of course the left code wouldn't be executed forever. </p>
<p>Ok, now let's just see what will happend in the call of <code>exit(0)</code>. </p>
<p>The definition of <code>exit()</code> function is in the file <code>/user/user.h</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">...</span>
<span class="c1">// system calls</span>
<span class="kt">int</span><span class="w"> </span><span class="n">fork</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">exit</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="k">noreturn</span><span class="p">));</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">wait</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">);</span>
<span class="p">...</span>
</code></pre></div></td></tr></table></div>
<p>We can see that its return value is an integer and it receives an inteter as its parameter. The <code>__attribute__((noreturn))</code> part is a compiler annotation telling the compilers (gcc &amp; clang both support this) this function wouldn't return. </p>
<p>However, this is just the definition of this function. In C/C++, we know that a definition of function isn't executable. Therefore, where is the implementation of this function?</p>
<p>The secret is in the file <code>/user/usys.pl</code>. This file is a Perl program. Perl is just like Python, which is also an interpreter-based language. </p>
<p>This <code>usys.pl</code> would generate the 'trigger' for function calls. This Perl script might be dense, but once you compile xv6 using <code>make qemu</code>, you can find the file generated by it, which is <code>/user/usys.S</code>. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># generated by usys.pl - do not edit</span>
<span class="c1">#include &quot;kernel/syscall.h&quot;</span>
<span class="na">...</span>
<span class="na">.global</span><span class="w"> </span><span class="no">exit</span>
<span class="nl">exit:</span>
<span class="w"> </span><span class="nf">li</span><span class="w"> </span><span class="no">a7</span><span class="p">,</span><span class="w"> </span><span class="no">SYS_exit</span>
<span class="w"> </span><span class="nf">ecall</span>
<span class="w"> </span><span class="nf">ret</span>
<span class="na">...</span>
</code></pre></div></td></tr></table></div>
<p>Generally, this <code>/user/usys.S</code>, which is an assembly code for RISC-V, has done two things-including <code>/kernel/syscall.h</code> and making many global symbols (declared by <code>.global **</code>, e.g., <code>.global exit</code> defines a symbol <code>exit</code>) with corresponding functions' assembly code.</p>
<p>Let's just use the example of <code>exit()</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">.global</span><span class="w"> </span><span class="no">exit</span><span class="w">        </span><span class="c1"># declare a symbol, you can image it as a variable</span>
<span class="nl">exit:</span><span class="w">               </span><span class="c1"># this is a tag, meaning symbol exit points to here</span>
<span class="w"> </span><span class="nf">li</span><span class="w"> </span><span class="no">a7</span><span class="p">,</span><span class="w"> </span><span class="no">SYS_exit</span><span class="w">    </span><span class="c1"># load immediate value, SYS_exit, into register a7</span>
<span class="w"> </span><span class="nf">ecall</span><span class="w">              </span><span class="c1"># system call instruction in RISC-V</span>
<span class="w"> </span><span class="nf">ret</span><span class="w">                </span><span class="c1"># return</span>
</code></pre></div></td></tr></table></div>
<p>There are still several questions in this <em>small</em> piece of assembly code.</p>
<ol>
<li>Where is the immediate value <code>SYS_exit</code>?</li>
<li>Where does the program go after we use <code>ecall</code> function?</li>
</ol>
<p>For the first question, let's get back to the first thing <code>usys.S</code> has done-the included file <code>/kernel/syscall.h</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// System call numbers</span>
<span class="cp">#define SYS_fork    1</span>
<span class="cp">#define SYS_exit    2</span>
<span class="cp">#define SYS_wait    3</span>
<span class="p">...</span>
</code></pre></div></td></tr></table></div>
<p>See? All the immediate values are define here and included into the assembly code by <code>#include "kernel/syscall.h"</code>. </p>
<p>For the second question, it's a little complicated. If you want to learn more, you can refer to <a href="https://pdos.csail.mit.edu/6.1810/2024/xv6/book-riscv-rev4.pdf">xv6 book</a> chapter 4.3. In short, <code>ecall</code> instruction in user mode (now we are running <code>hello-world</code>, which is a userspace program) will trap the execution into <code>uservec()</code> function in <code>trampoline.S</code> and further get into <code>usertrap()</code> function in <code>/kernel/trap.c</code>. </p>
<p>So far, the transition between user space and kernel space has done. The CPU's privilege mode has been set to 1, which is supervisor mode (S-mode). However, the memory page table hasn't been set to kernel's (you can think about the reason after you learn more). </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">void</span>
<span class="nf">usertrap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="w">    </span><span class="n">intr_on</span><span class="p">();</span>

<span class="w">    </span><span class="n">syscall</span><span class="p">();</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">((</span><span class="n">which_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devintr</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Following function <code>usertrap()</code> in <code>/kernel/trap.c</code>, it finally goes to <code>syscall(void)</code> function in <code>/kernel/syscall.c</code>. This function is easy to understand now (T.T compared to previous assembly code). </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">void</span>
<span class="nf">syscall</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myproc</span><span class="p">();</span>

<span class="w">    </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a7</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NELEM</span><span class="p">(</span><span class="n">syscalls</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">syscalls</span><span class="p">[</span><span class="n">num</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Use num to lookup the system call function for num, call it,</span>
<span class="w">        </span><span class="c1">// and store its return value in p-&gt;trapframe-&gt;a0</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syscalls</span><span class="p">[</span><span class="n">num</span><span class="p">]();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d %s: unknown sys call %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">);</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">a0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>At line 137, we got the number stored in user program's register <code>a7</code>. Feel familiar? Yes! It was stored a little before in the function <code>exit()</code> of <code>/user/usys.S</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="na">.global</span><span class="w"> </span><span class="no">exit</span><span class="w">        </span><span class="c1"># declare a symbol, you can image it as a variable</span>
<span class="nl">exit:</span><span class="w">               </span><span class="c1"># this is a tag, meaning symbol exit points to here</span>
<span class="w"> </span><span class="nf">li</span><span class="w"> </span><span class="no">a7</span><span class="p">,</span><span class="w"> </span><span class="no">SYS_exit</span><span class="w">    </span><span class="c1"># load immediate value, SYS_exit, into register a7 HERE!!!!!!!!!</span>
<span class="w"> </span><span class="nf">ecall</span><span class="w">              </span><span class="c1"># system call instruction in RISC-V</span>
<span class="w"> </span><span class="nf">ret</span><span class="w">                </span><span class="c1"># return</span>
</code></pre></div></td></tr></table></div>
<p><code>SYS_exit</code>, which is just the SYSTEM CALL NUMBER, was stored in user program and then read by kernel here. Magic, right?</p>
<p>Then there is a <code>if</code> statement judging whetehr the syscall number is greater than 0 and less than the number of elements in <code>syscalls</code> table. OK, now let's take a look at <code>syscalls</code> table. (It's from line 107 - 129)</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// An array mapping syscall numbers from syscall.h</span>
<span class="c1">// to the function that handles the system call.</span>
<span class="k">static</span><span class="w"> </span><span class="n">uint64</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">syscalls</span><span class="p">[])(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="p">[</span><span class="n">SYS_fork</span><span class="p">]</span><span class="w">    </span><span class="n">sys_fork</span><span class="p">,</span>
<span class="p">[</span><span class="n">SYS_exit</span><span class="p">]</span><span class="w">    </span><span class="n">sys_exit</span><span class="p">,</span>
<span class="p">...</span>
<span class="p">};</span>
</code></pre></div></td></tr></table></div>
<p>Here, this type might be hard to understand. To be simple, it's an array and each element in this array is a <a href="https://www.geeksforgeeks.org/function-pointer-in-c/"><em>function pointer</em></a>. The functions should have type of <code>uint64 function(void)</code>, which means these functions receive no arguments and return a single unsigned 64-bits integer. </p>
<p>Then, what's the values in this array? Let's use a simple C program example.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">arr</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="mh">0xdeadbeef</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Length of arr: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;arr[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You can simply copy this code and run it on your computer. The result should be:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>./main
Length<span class="w"> </span>of<span class="w"> </span>arr:<span class="w"> </span><span class="m">6</span>
arr<span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
arr<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
arr<span class="o">[</span><span class="m">2</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
arr<span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span>
arr<span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
arr<span class="o">[</span><span class="m">5</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-559038737
</code></pre></div></td></tr></table></div></p>
<p>Now, it's pretty obvious! The numbers in <code>[]</code> is the index and the number after each index is it's corresponding value. For example, we stored 10 to position 0 and 1000 to position 3. </p>
<blockquote>
<p>Note: this semantic isn't officially supported by C++, which means even it's a valid grammer in C, it might be failed in compilation for some C++ compilers. </p>
</blockquote>
<p>Now, let's come back to the <code>syscalls</code> array. There are some functions and each function is stored at the position of its system call number. For example, the syscall number for <code>exit()</code> is 2, which you can find in <code>/kernel/syscall.h</code>. Therefore <code>syscalls[2]</code> will be a function pointer pointing to <code>sys_exit()</code>. </p>
<p>We are close!</p>
<p>Then, what is <code>sys_exit()</code>? It's in file <code>/kernel/sysproc.c</code> and you can find it's pretty short. But before we get into the implementation of the function, we should know how can an array in <code>/kernel/syscall.c</code> use a function defined in <code>/kernel/sysproc.c</code>. If we want to use functions from another file, we typically define it in a header file and implement it in a source file. Whenever we want to use it, include the header file and call it. During the compilcation, we just need to pass these two source files to the compiler, it will find the function and link them. But... the situation here is a little different. As there is no header file defining the <code>sys_**</code> functions, functions in <code>/kernel/syscall.c</code> cannot find them. So, if you pay attention to the code just before the <code>syscalls[]</code> table, you will see there are a lot of <code>sys_**</code> functions defined as extern function. The key word <code>extern</code> tells the compiler, "this function's implementation is not here, but it will be somewhere else. I will give the source file including this function to you later. Now, you just assume you have already had the implemetation of this function. " </p>
<p>Good? To learn more about <code>extern</code> key word, you can refer this <a href="https://stackoverflow.com/questions/856636/effects-of-the-extern-keyword-on-c-functions">stack overflow thread</a>. </p>
<p>Now let's get into the implementation of <code>sys_exit()</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">uint64</span>
<span class="nf">sys_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="n">argint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// not reached</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Do you still remember what the definition of <code>exit()</code> syscall is in the user space? It's <code>int exit(int) __attribute__((noreturn))</code>. It has one argument and one return value, both are of integer type. But now, when coming to <code>sys_exit()</code>, the return value is still there, but where is our argument?</p>
<p>Here, we need to explain why we cannot directly pass our parameters using our normal way (i.e., <code>sys_exit(int)</code>). It is because when we stores the function pointers to <code>syscalls[]</code>, all functions should have the same type. However, different system call has their own type of parameters. Hence, for a more convenient call of system calls of different arguments type, we make all of them with non-argument and let them parse their own arguments in <code>sys_**()</code>. (No matter you understand or not, I'm confused now :( )</p>
<p>In the first line of the function, it prepare a value <code>n</code> for the argument passed for <code>exit()</code> syscall. <code>argint(0, &amp;n)</code> fetches the first value in the calling argument and stores it into variable <code>n</code>. Then it execute <code>exit(n)</code>. (Can it be the last function containing <code>exit</code>????)</p>
<p>OK, now let's see the very LAST <code>exit()</code> function. It's in the file <code>/kernel/proc.c</code>. However, before we step into the actual function implementation, we need know how <code>sys_exit()</code> finds <code>exit()</code> first. These two functions are defined in two differen  files, in order for one to find another, there should be a "bridge" for them. As we mentioned before, the most common bridge is a header file. Here, the same, there is a header file storing all definition of kernel functions (just like <code>/user/user.h</code>), which is <code>/kernel/defs.h</code>. You can also find it by doing a small search about the function definitions. </p>
<blockquote>
<p>Searching, finding where the definition and implementation is a very important skill in C/C++ programming. The documentation is sometimes (tbh, always) unreliable. Therefore, most of time you need to learn from the code by yourself. Currently, the C/C++ extension in VSCode is very powerful and you can tack the function call flow by simply using <code>ctrl + left click</code> (or <code>command + left click</code> on macOS). However, sometimes it may skip some definition. Therefore, search and filter by yourself is most reliable way. </p>
</blockquote>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// Exit the current process.  Does not return.</span>
<span class="c1">// An exited process remains in the zombie state</span>
<span class="c1">// until its parent calls wait().</span>
<span class="kt">void</span>
<span class="nf">exit</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myproc</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">initproc</span><span class="p">)</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;init exiting&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Close all open files.</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NOFILE</span><span class="p">;</span><span class="w"> </span><span class="n">fd</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ofile</span><span class="p">[</span><span class="n">fd</span><span class="p">]){</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ofile</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span>
<span class="w">            </span><span class="n">fileclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">            </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ofile</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">begin_op</span><span class="p">();</span>
<span class="w">    </span><span class="n">iput</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="p">);</span>
<span class="w">    </span><span class="n">end_op</span><span class="p">();</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait_lock</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Give any children to init.</span>
<span class="w">    </span><span class="n">reparent</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Parent might be sleeping in wait().</span>
<span class="w">    </span><span class="n">wakeup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

<span class="w">    </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">xstate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">    </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZOMBIE</span><span class="p">;</span>

<span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait_lock</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Jump into the scheduler, never to return.</span>
<span class="w">    </span><span class="n">sched</span><span class="p">();</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;zombie exit&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This function is well documented so I wouldn't write a lot to explain it. But we can see, in the end, it calls <code>sched()</code> which is the process scheduler. When it gets into the scheduler, the other ready processes will be run by the scheduler. </p>
<p>So, question is, where is our argument, the status for exit? It is stored in <code>p-&gt;xstate</code>, which is used for storing the exit status specially. </p>
<blockquote>
<p>I wrote all of this by my own. Hopefully it can help you understand how function call works. T_T</p>
</blockquote>
<h2 id="your-task">Your Task</h2>
<p>There is only one task for you, easy, not much work to do and only a few dozen lines of code could finish it. </p>
<p>Now, you may (or may not) know that, <code>fork()</code> will create a child process. Now, suppose you have one parent process with PID=1 and two child processes of him, PID=2 and PID=3. What if your parent want to wait for these two child processes finishing their work?</p>
<p>You can use <code>wait()</code> syscall. <code>wait()</code> will return once there is one child process exits (in another word, becomes <em>zombie</em> as we saw in <code>exit()</code>) after cleaning up all the memory for the child process. </p>
<p>Easy to understand, right?</p>
<p>Your task, is adding another system call with user space definition</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">waitpid</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>Explanation for parameters:</p>
<ol>
<li><code>int *status</code>, this is a pointer, the status of exited program should be stored into this location, just like <code>wait(int*)</code>. </li>
<li><code>int pid</code>, instead of waiting for arbitrary child process terminating, <code>waitpid()</code> should only wait for specific child with <code>pid</code>. To be more specific:<ol>
<li>If pid &lt;= 0, which means it's an invalid pid in xv6 (xv6 has a pid &gt; 0), your function should work as <code>wait(int*)</code>, which means it will return whenever a child process exits. </li>
<li>If pid &gt; 0, but the process with <code>pid</code> isn't the child of current process, your function should return -1. </li>
<li>If pid &gt; 0 and the process with <code>pid</code> is the child of current process, but the child process with <code>pid</code> isn't running, your funcion should return -1.</li>
<li>If pid &gt; 0 and the process with <code>pid</code> is the child of current process, the child process is running at the same time, your function should wait until its status becomes <code>zombie</code>. Then, clean up the memory the child process is using (just like in <code>wait()</code>) and return the status of the child process. </li>
</ol>
</li>
<li><code>options</code>, we'd play something in the function for this options. The <code>options</code> in Linux kernel is complex and it defines many macro for different function (you can take a look from <a href="https://linux.die.net/man/2/waitpid">here</a>). We don't need that complex <code>options</code>. Instead, we'd just use several values to change the operation of the function.<ol>
<li>If <code>options == 0</code> just run as normal (do nothing extra).</li>
<li>If <code>options == 1</code>, use <code>printf()</code> (you may be curious about this <code>printf()</code>, this <code>printf()</code> is different from the one we used in normal program, this one is defined under the kernel space of xv6, even though they have the same function.) to output a line of <code>OPTIONS=1</code> and a new line character <code>\n</code>. Then your function should do nothing and return 0.</li>
<li>If <code>options == 2</code>, do as normal, but when you store the status code of the child process, don't use the exact one, use a fake one <code>0x33</code> and the other things should be the same. </li>
<li>If <code>options == 3</code>, do nothing and return immediately with return value -1. </li>
</ol>
</li>
</ol>
<h2 id="step-by-step-instruction">Step-by-Step Instruction</h2>
<blockquote>
<p>Attention: as C program compilation is very flexible, it's not necessary for you to following the instruction so strictly. You can design, create, define and implement the function as you wish as long as it can work properly. If you aren't familiar to C programming or you haven't understand the background very well, you can start Lab 1 by just following the instructions here. </p>
</blockquote>
<p>So, following our mind in the background, let's start from user space. </p>
<hr />
<p>The first thing is adding a definition for our syscall in user space. It's inside the file <code>/user/user.h</code>. </p>
<blockquote>
<p>Don't understand the different between header file (.h file) and source file (.c)? Take a look at <a href="http://www.math.uaa.alaska.edu/~afkjm/csce211/handouts/SeparateCompilation.pdf">here</a> (from UAA). </p>
</blockquote>
<p>Take a look at our required user space definition for the system call and finish this part. </p>
<hr />
<p>The second thing is adding the syscall's implementation under user space. Now, take a little review in background, where is the syscalls' implementation in user space?</p>
<p>Remember that Perl script and generated assembly code? Yes, it's in <code>/user/usys.S</code>. However, this file is not written directly by us, instead it's generated by the Perl script. Don't worry if you don't understand the Perl script. Take a look at the script file <code>/user/usys.pl</code> and it's not hard to understand, right? The script sets a subroutine <code>entry</code> and it will print the corresponding entry assembly code for each syscalls defined here. Therefore, in order to add our <code>waitpid()</code> syscall, we need to add an entry here as well. </p>
<hr />
<p>OK, now you may have noticed that, in <code>/user/usys.pl</code>, it includes a file <code>/kernel/syscall.h</code> and it uses variable <code>SYS_${name}</code> defined in it. We have seen this file before and there are several system calls and its syscall number defined. So, pick up a desirable system call number and define it in <code>/kernel/syscall.h</code>. </p>
<blockquote>
<p>There are 21 system calls defined in xv6 and they have consecutive syscall numbers. It's natural for us picking a number 22 for our <code>waitpid()</code> syscall. But, is it really necessary? Can I choose other numbers here and what's the influence if I choose a very large number? If you cannot come up with an answer, remind yourself a little about the <code>syscalls[]</code> array we described in the background. </p>
</blockquote>
<hr />
<p>As you may notice, we are in the kernel level now. So, what is next step? It looks like all the clues stop here. </p>
<p>It's the time to review how a system call is triggered by the kernel-the trap, right? There is a trap file and it calls something related to <code>syscall()</code> (if you don't remember, just go back to the background). </p>
<p>Let go to <code>usertrap()</code> function and it seems there is nothing we can do here and it will finally get into function <code>syscall()</code> in <code>/kernel/syscall.c</code>. Here, we notice a old friend, the <code>syscalls[]</code> table, right? We have defined our syscall numbers in <code>/kernel/syscall.h</code>, therefore we have already had a constant number variable with name <code>SYS_**</code> corresponding to our syscall and here, we need to associate the syscall number with a concrete system call function, just like the association between the number <code>SYS_exit</code> (i.e., this number is 2 as we find in <code>syscall.h</code>) and <code>sys_exit()</code> function. </p>
<hr />
<p>OK, we make a connection between them, but wait, where is our system call function? </p>
<p>Firstly, there are some <code>extern</code> function defined just before this <code>syscalls[]</code> table, in order for our table can find the function, we should define an extern function corresponding to our <code>waitpid()</code> syscall here as well. </p>
<p>Then, let's find where <code>sys_exit()</code> is and it's in the file <code>/kernel/sysproc.c</code>. Do you remember, here, the <code>sys_exit()</code> prepare the arguments for the real <code>exit()</code> function. Similarly, we need to define a function here preparing arguments for the real <code>waitpid()</code> function. </p>
<p>Emmm... but the question is, we can learn from <code>sys_exit()</code> that if we want to fetch a integer from the argument, we need to use <code>argint()</code>. We have <code>pid</code> and <code>option</code> in integer, but how can I fetch a type <code>int*</code> for the argument? Don't worry, do you still remember <code>wait(int* status)</code> function call? There is a pointer as well! So, take a look at that function and you can find what you need. </p>
<p>Then, just finish this part by yourself. </p>
<hr />
<p>Now, we come to the most challenge part in the Lab and you need to implement the most of your code here, by yourself. We can follow the <code>sys_exit()</code> and it will call <code>exit(int)</code> in <code>/kernel/proc.c</code>. Similarly, you can define your <code>waitpid()</code> function here. </p>
<p>But stop for a minute. Do you still remember, in order to let <code>sys_exit()</code> find <code>exit()</code>, there is a definition for <code>exit()</code> in <code>/kernel/defs.h</code> and it is included in <code>/kernel/sysproc.c</code>. Therefore, make a definition for our <code>waitpid()</code> in <code>/kernel/defs.h</code> so that our <code>sys_waitpid()</code> could find the definition for this function. </p>
<p>Then, what to do? The most intuitive thing is that you can copy the code from <code>wait(int*)</code> function as they perform two similar things. Now, it's time to take a look at <a href="#your-task">your tasks</a> and implement it according to the requirements. </p>
<blockquote>
<p>If you meet any confusion during finishing the Lab, don't hesitate to ask! It might be my bad. Maybe I made an unreasonable requirement or I miss something in the code. </p>
</blockquote>
<h2 id="grading-policy">Grading Policy</h2>
<p>10 pts in total:</p>
<ol>
<li>2 pts for the attendance. </li>
<li>8 pts for the Lab code (as shown in autograder if you submit your report). If you don't have a report submitted, your grade for the code will receive a 50% penalty. </li>
</ol>
<p>We reserve the rights to grade your Lab according to your report in any situation. You can make a request for grading your Lab just according to your report if you cannot submit a runnable code. But we can't ensure we will give you any grade. </p>
<p>We may also grade your assignment just according to your report (which means we will give up your grade in autograder) if we find any <strong>SENSITIVE</strong> code in your work or we find some unmatch performance for you between the labs and lectures. To avoid this case, understand and following the instruction well, write the code by yourself and never share your code with others. </p>
<blockquote>
<p>The grades on Github Actions might not be correct if you partially passed test cases. The grades on the table is always calculated by <span class="arithmatex">\(\frac{8.0}{5} \times \text{PASSED CASES}\)</span>. But the final grades below is always correct. Please refer to <code>Test</code> section above <code>autograding reporter</code> for the actual grades distribution.</p>
</blockquote>
<h2 id="what-to-write-in-report">What to write in report</h2>
<p>We don't expect a very detailed report. Keep it in 2-3 pages. You don't need to copy, paste and explain your code in the report, as we can find them in your repo. </p>
<p>Instead, you need to explain</p>
<ol>
<li>Which files you modified and the reason for the modification. </li>
<li>Is there any difficulty you met and how do you solve them. </li>
<li>If let you pick some special functions for more options, what will you choose and do you have some reality reason for this choice. (e.g., there are many options for <code>waitpid()</code> in the real world Linux and they all have their corresponding existing reasons). </li>
</ol>
<p>You can add other things in the report as well if you like. </p>
<h2 id="test-program">Test Program</h2>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel/types.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;user/user.h&quot;</span>

<span class="cm">/******************************/</span>
<span class="c1">// (1)</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">srand</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">lcg_rand</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1103515245</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">107</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">seed</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************/</span>
<span class="c1">// (2)</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">test_waitpid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">nproc</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">childs</span><span class="p">[</span><span class="n">nproc</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// initialize return status for child processes</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nproc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lcg_rand</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nproc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="w">        </span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sleep</span><span class="p">(</span><span class="n">lcg_rand</span><span class="p">()</span><span class="o">%</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid] created %d processes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nproc</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nproc</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">actual_status</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitpid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">actual_status</span><span class="p">,</span><span class="w"> </span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid] waiting for pid[0x%x] with expected xstate[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid] waitpid: expected pid[0x%x] but got pid[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">actual_status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid] waitpid: expected xstate[0x%x] for pid[0x%x] but got [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">actual_status</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid] Sinocentric Epoch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************/</span>
<span class="c1">// (3)</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">test_waitpid_pid_le_0</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">nproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">nproc</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">childs</span><span class="p">[</span><span class="n">nproc</span><span class="p">];</span>
<span class="w">    </span><span class="c1">// initialize return status for child processes</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nproc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lcg_rand</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nproc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="w">        </span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sleep</span><span class="p">(</span><span class="n">lcg_rand</span><span class="p">()</span><span class="o">%</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_pid_le_0] created %d processes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nproc</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nproc</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">actual_status</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitpid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">actual_status</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_pid_le_0] get pid[0x%x] return with xstate[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">actual_status</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">flg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nproc</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">childs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">childs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">                </span><span class="n">flg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">actual_status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_pid_le_0] waitpid: expected xstate[0x%x] for pid[0x%x] but got [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">actual_status</span><span class="p">);</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">flg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_pid_le_0] pid[0x%x] not a valid child</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_pid_le_0] Sinocentric Epoch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************/</span>
<span class="c1">// (4)</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">test_waitpid_pid_not_child</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">lcg_rand</span><span class="p">()</span><span class="o">%</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">wait_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitpid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">wait_pid</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_pid_not_child] waitpid: expected -1 but got retval[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_pid_le_0] Sinocentric Epoch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************/</span>
<span class="c1">// (5)</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">test_waitpid_option_1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">lcg_rand</span><span class="p">()</span><span class="o">%</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="n">lcg_rand</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitpid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_option_1] waitpid: expected 0 but got retval[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitpid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_option_1] waitpid: expected pid[0x%x] but got pid[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_option_1] Sinocentric Epoch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/******************************/</span>
<span class="c1">// (6)</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">test_waitpid_option_2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">lcg_rand</span><span class="p">()</span><span class="o">%</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="n">lcg_rand</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waitpid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_option_2] waitpid: expected pid[0x%x] but got retval[0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x33</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_option_2] waitpid: expected xstate[0x33] but got [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_waitpid_option_2] Sinocentric Epoch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tests</span><span class="p">[])(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">test_waitpid</span><span class="p">,</span>
<span class="w">    </span><span class="n">test_waitpid_pid_le_0</span><span class="p">,</span>
<span class="w">    </span><span class="n">test_waitpid_pid_not_child</span><span class="p">,</span>
<span class="w">    </span><span class="n">test_waitpid_option_1</span><span class="p">,</span>
<span class="w">    </span><span class="n">test_waitpid_option_2</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">all_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tests</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tests</span><span class="p">[</span><span class="n">i</span><span class="p">]()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">flg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[all_test] test[%d] failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flg</span><span class="p">)</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[all_test] all tests passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">srand</span><span class="p">(</span><span class="n">uptime</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tests</span><span class="p">[</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])]();</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">all_test</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>A random number generator. </li>
<li>Test basic <code>waitpid()</code> implementation.</li>
<li>Test when <code>pid &lt;= 0</code>.</li>
<li>Test when <code>pid</code> is not a child process of current process. </li>
<li>Test <code>option == 1</code>.</li>
<li>Test <code>option == 2</code>.</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Zhaoqi Xiao. All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>