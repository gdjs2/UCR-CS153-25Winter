
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lab Session for CS153 Design of Operating System">
      
      
        <meta name="author" content="Zhaoqi Xiao">
      
      
        <link rel="canonical" href="http://gdjs2.cn/UCR-CS153-25Winter/lab-instructions/lab2/">
      
      
        <link rel="prev" href="../lab1/">
      
      
        <link rel="next" href="../pull-request/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>Lab 2 - Scheduler - CS153 Design of Operating System - Lab Session</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-2-scheduler" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CS153 Design of Operating System - Lab Session" class="md-header__button md-logo" aria-label="CS153 Design of Operating System - Lab Session" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CS153 Design of Operating System - Lab Session
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 2 - Scheduler
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CS153 Design of Operating System - Lab Session" class="md-nav__button md-logo" aria-label="CS153 Design of Operating System - Lab Session" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    CS153 Design of Operating System - Lab Session
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CS153 - Design of Operating System - Lab Session - 25 Winter
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Lab instructions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Lab instructions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../c-pointers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to C language and Pointers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 0 Instructions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 1 - System Call
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lab 2 - Scheduler
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lab 2 - Scheduler
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#accept-your-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      Accept Your Assignment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      What is scheduler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preemptive-vs-non-preemptive" class="md-nav__link">
    <span class="md-ellipsis">
      Preemptive v.s. Non-Preemptive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduling-algorithms" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduling Algorithms
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scheduling Algorithms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-in-first-out-fifo" class="md-nav__link">
    <span class="md-ellipsis">
      First-In, First-Out (FIFO)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#round-robin-rr" class="md-nav__link">
    <span class="md-ellipsis">
      Round Robin (RR)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#priority-based" class="md-nav__link">
    <span class="md-ellipsis">
      Priority-Based
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#burst-time-turnaround-time-and-waiting-time" class="md-nav__link">
    <span class="md-ellipsis">
      Burst Time, Turnaround Time and Waiting Time
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ticks-in-xv6-riscv" class="md-nav__link">
    <span class="md-ellipsis">
      Ticks in xv6-riscv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduler-in-xv6-riscv" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduler in xv6-riscv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locks-in-struct-proc" class="md-nav__link">
    <span class="md-ellipsis">
      Locks in struct proc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#your-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Your Tasks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Your Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#breakdown" class="md-nav__link">
    <span class="md-ellipsis">
      Breakdown
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instruction" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Instruction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-tips" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Tips
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grading-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Grading Policy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-to-write-in-report" class="md-nav__link">
    <span class="md-ellipsis">
      What to write in report
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-program" class="md-nav__link">
    <span class="md-ellipsis">
      Test Program
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pull-request/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Github Classroom Pull Request
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#accept-your-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      Accept Your Assignment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Background">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-scheduler" class="md-nav__link">
    <span class="md-ellipsis">
      What is scheduler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preemptive-vs-non-preemptive" class="md-nav__link">
    <span class="md-ellipsis">
      Preemptive v.s. Non-Preemptive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scheduling-algorithms" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduling Algorithms
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scheduling Algorithms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-in-first-out-fifo" class="md-nav__link">
    <span class="md-ellipsis">
      First-In, First-Out (FIFO)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#round-robin-rr" class="md-nav__link">
    <span class="md-ellipsis">
      Round Robin (RR)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#priority-based" class="md-nav__link">
    <span class="md-ellipsis">
      Priority-Based
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#burst-time-turnaround-time-and-waiting-time" class="md-nav__link">
    <span class="md-ellipsis">
      Burst Time, Turnaround Time and Waiting Time
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ticks-in-xv6-riscv" class="md-nav__link">
    <span class="md-ellipsis">
      Ticks in xv6-riscv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduler-in-xv6-riscv" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduler in xv6-riscv
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#locks-in-struct-proc" class="md-nav__link">
    <span class="md-ellipsis">
      Locks in struct proc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#your-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Your Tasks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Your Tasks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#breakdown" class="md-nav__link">
    <span class="md-ellipsis">
      Breakdown
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instruction" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-Step Instruction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-tips" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Tips
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grading-policy" class="md-nav__link">
    <span class="md-ellipsis">
      Grading Policy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-to-write-in-report" class="md-nav__link">
    <span class="md-ellipsis">
      What to write in report
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-program" class="md-nav__link">
    <span class="md-ellipsis">
      Test Program
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="lab-2-scheduler">Lab 2 - Scheduler</h1>
<h2 id="accept-your-assignment">Accept Your Assignment</h2>
<p><a href="https://classroom.github.com/a/sFukyoo3">https://classroom.github.com/a/sFukyoo3</a></p>
<p><strong>Due: Sunday, Feb 23rd, 2025, 23:59, PST</strong></p>
<h2 id="background">Background</h2>
<p>If you have been familiar with preemptive/non-preemptive scheduling, FIFO, RR, Priority-Based scheduling algorithms. You can skip to <a href="#ticks-in-xv6-riscv">ticks in xv6</a></p>
<h3 id="what-is-scheduler">What is scheduler</h3>
<p>The scheduler is a critical component of an operating system kernel responsible for managing and prioritizing access to the CPU(s) among multiple processes or threads. Its primary role is to decide which task runs next and for how long, ensuring efficient resource utilization and fair allocation.</p>
<h3 id="preemptive-vs-non-preemptive">Preemptive v.s. Non-Preemptive</h3>
<p>A scheduling strategy is non-preemptive if the scheduling happens only when a running task voluntarily releases the CPU, typically when it:</p>
<ul>
<li>Completes execution.</li>
<li>Blocks for I/O or synchronization (e.g., <code>sleep()</code>, <code>wait()</code>)</li>
</ul>
<p>Modern OS like Linux/Windows/macOS all use preemptive scheduling. </p>
<p>For preemptive scheduling, the OS kernel forcibly interrupts a running task to allocate CPU time to another task. A preemptive scheduling is often triggered by:</p>
<ul>
<li>Time-slice exhaustion (e.g., Round Robin scheduling)</li>
<li>Arrival of a higher-priority task.</li>
</ul>
<p>A preemptive scheduling typically relies on hardware timer. </p>
<p>In xv6-riscv, the initial scheduler is a preemptive round robin scheduler. </p>
<h3 id="scheduling-algorithms">Scheduling Algorithms</h3>
<h4 id="first-in-first-out-fifo">First-In, First-Out (FIFO)</h4>
<p>FIFO (also called First-Come, First-Served, FCFS) is a non-preemptive CPU scheduling algorithm where processes are executed in the exact order they arrive in the ready queue.</p>
<p>Key Principles:</p>
<ul>
<li>Non-Preemptive Execution<ul>
<li>A process retains the CPU until it completes or voluntarily blocks (e.g., for I/O).</li>
<li>No interruption occurs mid-execution, even for higher-priority processes.</li>
</ul>
</li>
<li>Queue Structure<ul>
<li>Processes are managed in a FIFO queue.</li>
<li>Newly arriving processes join the end of the queue.</li>
<li>Pick the first process in the queue for running.</li>
</ul>
</li>
</ul>
<hr />
<h4 id="round-robin-rr">Round Robin (RR)</h4>
<p>Round Robin is a preemptive algorithm. It ensures fair CPU time allocation by cycling through processes in a fixed order. </p>
<p><strong>Key Principles:</strong></p>
<ul>
<li>Time Slice (Quantum)<ul>
<li>Each process is assigned a fixed time quantum (e.g., 10-100ms in real world, 1 CPU cycle in xv6-riscv). </li>
<li>The process runs until it either:<ul>
<li>Completes within its time slice.</li>
<li>Is interrupted when the time slice expires. </li>
</ul>
</li>
</ul>
</li>
<li>Ready Queue<ul>
<li>Processes are arranged in a First-In-First-Out (FIFO) queue.</li>
<li>After a process uses its time slice, it is moved to the end of the queue, and the next process runs. </li>
</ul>
</li>
</ul>
<p><strong>Example Workflow:</strong></p>
<p>Assume we have three processes (P1, P2, P3) with a time quantum of 4ms:</p>
<table>
<thead>
<tr>
<th>Time (ms)</th>
<th>Action</th>
<th>Ready Queue State</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>P1 runs (4ms allocated)</td>
<td>[P2, P3]</td>
</tr>
<tr>
<td>4</td>
<td>P1 preempted -&gt; P2 runs</td>
<td>[P3, P1]</td>
</tr>
<tr>
<td>8</td>
<td>P2 preempted -&gt; P3 runs</td>
<td>[P1, P2]</td>
</tr>
<tr>
<td>12</td>
<td>P3 preempted -&gt; P1 runs again</td>
<td>[P2, P3]</td>
</tr>
</tbody>
</table>
<p><strong>Advantages:</strong></p>
<ul>
<li>Fairness: No process starves; all get equal CPU time over cycles. </li>
<li>Responsiveness: Ideal for interactive systems (e.g., GUIs) where tasks need frequent updates. </li>
<li>Simplicity: Easy to implement and predict.</li>
</ul>
<p><strong>Disadvantage:</strong></p>
<ul>
<li>Overhead: Frequent context switches waste CPU time if the quantum is too small.</li>
<li>Throughput: Less efficient than priority-based schedulers for long-running tasks. </li>
</ul>
<hr />
<h4 id="priority-based">Priority-Based</h4>
<p>Priority-Based Scheduling allocates CPU time to processes based on their assigned priority levels. Processes with higher priority are executed first, making it ideal for systems where urgent tasks must preempt less critical ones (e.g., real-time systems).</p>
<p><strong>Key Principles:</strong></p>
<ul>
<li>Priority Assignment<ul>
<li>Each process is assigned a priority value (numeric, e.g., 0-99, where 0 = highest priority.</li>
<li>Priorities can be:<ul>
<li>Static: Fixed at process creation (e.g., real-time tasks).</li>
<li>Dynamic: Adjusted during runtime (e.g., aging to prevent starvation).</li>
</ul>
</li>
</ul>
</li>
<li>Preemption Modes<ul>
<li>Preemptive: A higher-priority process immediately interrupts a running lower-priority one.</li>
<li>Non-Preemptive: A running process completes its burst time before yielding to higher-priority tasks.</li>
<li><em>Attention:</em> the preemption modes here is different from preemptive/non-preemptive algorithm. Priority-Based scheduling algorithm is a preemptive scheduling algorithm, while it has two preemption modes (preemptive/non-preemptive when a higher-priority process occurs). </li>
</ul>
</li>
</ul>
<h3 id="burst-time-turnaround-time-and-waiting-time">Burst Time, Turnaround Time and Waiting Time</h3>
<p><strong>Burst Time</strong></p>
<p>We use burst time representing the continuous execution time of a single CPU occupation by a process. </p>
<p>For example, <code>p</code> is scheduled to run by scheduler at time <span class="arithmatex">\(t_0\)</span> and it finishes/interrupted by kernel at time <span class="arithmatex">\(t\)</span>. The burst time for this execution of <code>p</code> is <span class="arithmatex">\(t-t_0\)</span>. </p>
<p>We also use total burst time representing the total CPU occupation time by a process. </p>
<p>For example, <code>p</code> was scheduled for <code>4</code> times and the burst times are <span class="arithmatex">\([t_0, t_1, t_2, t_3]\)</span>. The total burst time of <code>p</code> for now is <span class="arithmatex">\(t_0 + t_1 + t_2 + t_3\)</span>. </p>
<p><strong>Turnaround Time</strong></p>
<p>Assume process <code>p</code> was created at time <span class="arithmatex">\(t_0\)</span> and <code>p</code> finished at time <span class="arithmatex">\(t\)</span>. Turnaround time of finished process <code>p</code> is <span class="arithmatex">\(t-t_0\)</span>. It's the total time for finishing a process. </p>
<p><strong>Waiting Time</strong></p>
<p>Assume process <code>p</code> was created at time <span class="arithmatex">\(t_0\)</span> and current time is <span class="arithmatex">\(t\)</span>. For now, <code>p</code>'s total burst time is <span class="arithmatex">\(t_b\)</span>. The waiting time of <code>p</code> for now is <span class="arithmatex">\((t-t_0) - t_b\)</span>. <span class="arithmatex">\(t-t_0\)</span> is the total time from <code>p</code> is created to now. Waiting time is the total time subtracted total burst time. </p>
<h2 id="ticks-in-xv6-riscv">Ticks in xv6-riscv</h2>
<p>In real world OS, we evaluate the time using cycles or seconds. In xv6-riscv, there is another unit for evaluating the time, which is <code>ticks</code>. </p>
<p><code>ticks</code> is defined at the beginning of <code>trap.c</code>. It's defined globally, therefore its initial value is 0. <code>ticks</code> will be incremented whenever a time quantum is used. </p>
<p>The execution flow path for incrementing <code>ticks</code> is <code>usertrap()</code> -&gt; <code>devintr()</code> -&gt; <code>clockintr()</code>. </p>
<p>You can get current <code>ticks</code> by using system call <code>uptime()</code> in user space program. If you are in kernel space, you can directly access variable <code>ticks</code>, which is defined in <code>def.h</code> as an external variable. Its real declaration is in <code>trap.c</code>. </p>
<p>We will use <code>ticks</code> as the unit for evaluating the time in this lab. </p>
<h2 id="scheduler-in-xv6-riscv">Scheduler in xv6-riscv</h2>
<p>The initial scheduler in xv6-riscv is a RR scheduler. Before we get into the scheduler itself, we need understand how this RR scheduler works in xv6-riscv. </p>
<hr />
<p><strong>Periodic Interrupts for OS (in Supervision mode)</strong></p>
<p>One important but often neglected part in time-sliced RR scheduler is the periodic interrupts in the kernel. RR scheduler requires periodic interrupts from the hardware so that it can preempt the execution of current process. </p>
<p>In xv6-riscv, related code is in <code>/kernel/start.c</code>. There is a function named <code>timerinit()</code>, which initializes the timer. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// ask each hart to generate timer interrupts.</span>
<span class="kt">void</span>
<span class="nf">timerinit</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// enable supervisor-mode timer interrupts.</span>
<span class="w">  </span><span class="n">w_mie</span><span class="p">(</span><span class="n">r_mie</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MIE_STIE</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// enable the sstc extension (i.e. stimecmp).</span>
<span class="w">  </span><span class="n">w_menvcfg</span><span class="p">(</span><span class="n">r_menvcfg</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="mf">1L</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">63</span><span class="p">));</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// allow supervisor to use stimecmp and time.</span>
<span class="w">  </span><span class="n">w_mcounteren</span><span class="p">(</span><span class="n">r_mcounteren</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ask for the very first timer interrupt.</span>
<span class="w">  </span><span class="n">w_stimecmp</span><span class="p">(</span><span class="n">r_time</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1000000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<hr />
<p><strong>Interruption Handler</strong></p>
<p>We have met this handler before in system call. System call is a kind of interrupt from user space to kernel space and this timer interrupt is from user space to kernel space as well. So they are both trapped by the same function <code>usertrap()</code> in <code>trap.c</code>. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">//</span>
<span class="c1">// handle an interrupt, exception, or system call from user space.</span>
<span class="c1">// called from trampoline.S</span>
<span class="c1">//</span>
<span class="kt">void</span>
<span class="nf">usertrap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">which_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">if</span><span class="p">((</span><span class="n">r_sstatus</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">SSTATUS_SPP</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;usertrap: not from user mode&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// send interrupts and exceptions to kerneltrap(),</span>
<span class="w">  </span><span class="c1">// since we&#39;re now in the kernel.</span>
<span class="w">  </span><span class="n">w_stvec</span><span class="p">((</span><span class="n">uint64</span><span class="p">)</span><span class="n">kernelvec</span><span class="p">);</span>

<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myproc</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// save user program counter.</span>
<span class="w">  </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r_sepc</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">r_scause</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">){</span>
<span class="w">    </span><span class="c1">// system call</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="n">syscall</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">((</span><span class="n">which_dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">devintr</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
<span class="w">    </span><span class="c1">// ok</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">killed</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// give up the CPU if this is a timer interrupt.</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">which_dev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">yield</span><span class="p">();</span>

<span class="w">  </span><span class="n">usertrapret</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>At the end of this function, there is a if statement <code>which_dev == 2</code> checking whether this interrupt is triggered by timer. We can see <code>yield()</code> function is called if it's a timer interrupt. </p>
<hr />
<p><strong>Yield Function</strong></p>
<p>The <code>yield()</code> function is in <code>proc.c</code>. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// Give up the CPU for one scheduling round.</span>
<span class="kt">void</span>
<span class="nf">yield</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myproc</span><span class="p">();</span>
<span class="w">  </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">  </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RUNNABLE</span><span class="p">;</span>
<span class="w">  </span><span class="n">sched</span><span class="p">();</span>
<span class="w">  </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>It gets the current running process <code>p</code> and sets its state with <code>RUNNABLE</code>, which means <code>p</code> has finished his burst time. </p>
<p><code>sched()</code> function is called afterwards. This function does a context switch from process <code>p</code> and current kernel process.</p>
<p>Now we need to know, before <code>p</code> gets to run, the control is in <code>scheduler()</code> function. Line 31 is the point where user space process <code>p</code> is executed and also it's the point to be returned whenever <code>p</code> finishes its running. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// Per-CPU process scheduler.</span>
<span class="c1">// Each CPU calls scheduler() after setting itself up.</span>
<span class="c1">// Scheduler never returns.  It loops, doing:</span>
<span class="c1">//  - choose a process to run.</span>
<span class="c1">//  - swtch to start running that process.</span>
<span class="c1">//  - eventually that process transfers control</span>
<span class="c1">//    via swtch back to the scheduler.</span>
<span class="kt">void</span>
<span class="nf">scheduler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">cpu</span><span class="w"> </span><span class="o">*</span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mycpu</span><span class="p">();</span>

<span class="w">  </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="p">(;;){</span>
<span class="w">    </span><span class="c1">// The most recent process to run may have had interrupts</span>
<span class="w">    </span><span class="c1">// turned off; enable them to avoid a deadlock if all</span>
<span class="w">    </span><span class="c1">// processes are waiting.</span>
<span class="w">    </span><span class="n">intr_on</span><span class="p">();</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">proc</span><span class="p">[</span><span class="n">NPROC</span><span class="p">];</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">acquire</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RUNNABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Switch to chosen process.  It is the process&#39;s job</span>
<span class="w">        </span><span class="c1">// to release its lock and then reacquire it</span>
<span class="w">        </span><span class="c1">// before jumping back to us.</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RUNNING</span><span class="p">;</span>
<span class="w">        </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">        </span><span class="n">swtch</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// (1)</span>
<span class="w">        </span><span class="c1">// Process is done running for now.</span>
<span class="w">        </span><span class="c1">// It should have changed its p-&gt;state before coming back.</span>
<span class="w">        </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">found</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// nothing to run; stop running on this core until an interrupt.</span>
<span class="w">      </span><span class="n">intr_on</span><span class="p">();</span>
<span class="w">      </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;wfi&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>User space process is switched out from here. After the process finishes, <code>sched()</code> function will switch back to this point of scheduler function and start the next round of scheduling. </li>
</ol>
<blockquote>
<p>Context switch function is written in assembly code and it's in <code>swtch.S</code>. </p>
</blockquote>
<hr />
<p><strong>Scheduler</strong></p>
<p>This function is not hard to understand. It consists of a big infinite <code>for</code> loop. In each round, it picks up a <code>RUNNABLE</code> process and run it if possible (for loop from line 22-38). If it cannot find a <code>RUNNABLE</code> process (if statement at line 39), it will enable interrupt and use <code>wfi</code> instruction telling CPU to stop running until the next interrupt. </p>
<p>For process picking, this function goes over the process list, find a <code>RUNNABLE</code> process and run it. That's it. This is just a simply RR scheduling implementation. </p>
<h2 id="locks-in-struct-proc">Locks in <code>struct proc</code></h2>
<p><strong>What are Locks</strong></p>
<p>In computer science, locks are synchronization mechanisms used to control access to shared resources in a multi-threaded or multi-process environment. They ensure that only one thread or process can access a critical section of code or a shared resource at a time, preventing race conditions and maintaining data consistency.</p>
<p><strong>Why are Locks Needed</strong></p>
<p>In modern operating systems and applications, multiple threads or processes often run concurrently and may need to access shared resources (e.g., variables, data structures, files). Without proper synchronization, concurrent access can lead to:</p>
<p>Race Conditions: When the behavior of a program depends on the timing of thread execution, leading to unpredictable or incorrect results.
Data Corruption: When multiple threads modify shared data simultaneously, resulting in inconsistent or corrupted data.
Locks solve these problems by enforcing mutual exclusion: only one thread can hold a lock at a time, ensuring that shared resources are accessed in a controlled and safe manner.</p>
<p><strong>How do Locks Work</strong></p>
<p>A lock typically has two main operations:</p>
<p>Acquire (or Lock): A thread requests ownership of the lock. If the lock is available, the thread acquires it and proceeds to the critical section. If the lock is held by another thread, the requesting thread waits (blocks) until the lock is released.</p>
<p>Release (or Unlock): The thread that currently holds the lock releases it, allowing other threads to acquire the lock and access the critical section.</p>
<p><strong>Types of Locks</strong></p>
<ul>
<li>Mutex (Mutual Exclusion Lock):<ul>
<li>A basic lock that allows only one thread to access a resource at a time.</li>
<li>Example: Protecting a shared variable or data structure.</li>
</ul>
</li>
<li>Spinlock:<ul>
<li>A lock where the thread repeatedly checks (spins) until the lock becomes available.</li>
<li>Used in scenarios where waiting times are expected to be short.</li>
</ul>
</li>
<li>Semaphores:<ul>
<li>A generalized lock that allows a specified number of threads to access a resource simultaneously.</li>
<li>Can be used for more complex synchronization scenarios.</li>
</ul>
</li>
</ul>
<hr />
<p><strong>Locks in <code>struct proc</code> of xv6-riscv</strong></p>
<p>In fact, we have used <code>locks</code> in lab 1. In <code>wait()</code> system call, there are multiple function calls like <code>acquire(...)</code> and <code>release(...)</code> and if you didn't handle these function calls properly, there might be a panic during execution. </p>
<p>Here, we'd like to learn these locks and know when do we need to use <code>locks</code>. </p>
<p>In <code>proc.h</code>, the definition of <code>struct proc</code>, there are three types of fields and they are well classified into three categories-<code>p-&gt;lock</code> must be held, <code>wait_lock must be held</code> and <code>private</code>. </p>
<p>In <code>wait()</code>, because multiple CPUs could access <code>state</code>, <code>xstate</code> and <code>pid</code> simultaneously, <code>p-&gt;locks</code> is needed when accessing these fields. </p>
<p>In this lab, you may need to add several fields like <code>priority</code>, <code>start_time</code> and <code>burst_time</code> in <code>struct proc</code>. These fields should belong to the first category-<code>p-&gt;lock</code> required. <strong>Please include the reason for this in your report.</strong></p>
<h2 id="your-tasks">Your Tasks</h2>
<h3 id="overview">Overview</h3>
<p>Your task for this Lab is implementing a time-sliced priority-based scheduler with aging strategy. </p>
<hr />
<p><em>Time-sliced priority-based scheduler</em></p>
<p>A time-sliced priority-based scheduler is quite similar to a RR scheduler. It also runs each process with a fixed time slice. The only difference is that, RR scheduler picks the process one by one while our scheduler will always pick the process with the highest priority (<strong>to make it simple, if multiple processes have the same priority, pick the most previous one in the process list</strong>).</p>
<hr />
<p><em>Aging</em></p>
<p>Aging strategy is used for solving starvation in Priority-Based scheduling. In Priority-Based scheduling, if a process with higher priority requires a lot of time to finish, it will take the CPU for a long time, which causes other processes hardly running. </p>
<p>To solve this, instead of having a fixed priority value for each process, the scheduler adjusts the priority value for processes during dynamically. A simple case is that, every time the scheduler picks a process <code>p</code> to run, <code>p</code>'s priority will be deceased and other processes' priority value increase.</p>
<p>You will be required to apply a simple aging strategy to avoid starvation in this lab. </p>
<hr />
<p><span class="arithmatex">\(3\)</span> more system calls are required to implement for this lab.</p>
<h3 id="breakdown">Breakdown</h3>
<p><strong>Time-Sliced Priority-Based Scheduler</strong></p>
<ul>
<li>A time-sliced priority-based scheduling. <ul>
<li>Based on the RR scheduler of xv6-riscv.</li>
<li>Add a field in <code>struct proc</code> representing the scheduling priority of this process. We use an <code>unsigned char</code> or <code>uint8</code> type for this priority. It's value ranged from <span class="arithmatex">\(0\)</span> to <span class="arithmatex">\(255\)</span>. <strong><span class="arithmatex">\(0\)</span> means the highest priority and <span class="arithmatex">\(255\)</span> is for the lowest priority.</strong> The default priority for a process should be <span class="arithmatex">\(128\)</span></li>
<li>When picking the next process for execution, instead of picking the very first <code>RUNNABLE</code> one in the queue, pick the very first one with the highest priority in the queue. </li>
</ul>
</li>
<li>Aging strategy.</li>
<li>When a process is executed by the scheduler, its priority value will be increased by <span class="arithmatex">\(1\)</span>. </li>
</ul>
<p><strong>Extra System Calls</strong></p>
<blockquote>
<p>All definition requirements are for the user space. </p>
</blockquote>
<!-- -----------
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// Returns the total burst time (in ticks) of the process with `pid`. </span>
<span class="kt">int</span><span class="w"> </span><span class="nf">ticks</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>

Example: Process `p` was scheduled for $3$ times by scheduler and it finished all its time slice. When I call `ticks(p)`, it should return $3$. 

Return the ticks for current process if `pid` isn't valid (i.e., there is no process with `pid`). 

--------------
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// Get the waiting time for process with `pid`</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">waiting_ticks</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>

Example: Process `p` is created at tick $10$. Current time is tick $20$. `p` was scheduled for $3$ times during this time. The waiting time is $20-10-3=7$. 

Return the waiting time (in ticks) for current process if `pid` is not valid (same as above). -->

<hr />
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">// Set the priority value of current process with p. </span>
<span class="kt">int</span><span class="w"> </span><span class="nf">setpriority</span><span class="p">(</span><span class="n">uint8</span><span class="w"> </span><span class="n">priority</span><span class="p">);</span>
<span class="c1">// Get the priority value of process with `pid`. If `pid` isn&#39;t valid, return the one of current process.</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">getpriority</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p><code>setpriority(0)</code> will set the priority value of current process (which calls <code>setpriority()</code> function) to <code>0</code>. 
<code>getpriority(5)</code> will return the priority value of process with <code>pid</code> == 5 if there is. Otherwise, return the priority value of current process.</p>
<hr />
<p>We have learned this in lab 1. The original definition of <code>wait()</code> is <code>int wait(int *status)</code>. In this lab, we also need to implement another version of <code>wait()</code>, which is <code>wait_and_get_ticks()</code>.</p>
<p>The definition of <code>wait_and_get_ticks()</code> is 
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">wait_and_get_ticks</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">ticks</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">turnaround_ticks</span><span class="p">);</span>
</code></pre></div></td></tr></table></div></p>
<p>Besides the status, which is the return value of the child process needs to be stored and passed to parent process, another two fields <code>ticks</code>-the execution time (in ticks) and <code>turnaround_ticks</code>-the turnaround time (in ticks) need to be stored to the the pointer <code>ticks</code> and <code>turnaround_ticks</code> as well. </p>
<blockquote>
<p><code>ticks</code> and <code>turnaround_ticks</code> are in the user space. Handle this carefully. </p>
</blockquote>
<h2 id="step-by-step-instruction">Step-by-Step Instruction</h2>
<p>There is no step-by-step instruction for lab 2.</p>
<h2 id="implementation-tips">Implementation Tips</h2>
<ol>
<li>Implement the three system calls first. It is well-introduced in lab 1 about how to make new system calls.</li>
<li>The major modification lays on <code>scheduler()</code> function in <code>proc.c</code>. Current scheduler uses RR algorithm and you can start from it for our time-sliced priority-based scheduler. </li>
<li>You may need to add additional fields in <code>struct proc</code> or other structure  to assist <code>scheduler()</code> and/or extra system calls. </li>
<li>You may need to set <code>CPUs</code> variable in <code>Makefile</code> to <span class="arithmatex">\(1\)</span> to see a sequential &amp; explainable results. </li>
</ol>
<h2 id="grading-policy">Grading Policy</h2>
<p>10 pts in total:</p>
<ol>
<li>2 pts for the attendance. </li>
<li>6 pts for the Lab code (2 pts will be shown in autograder, 4 pts will be graded manually). If you don't have a report submitted, your grade for the code will receive a 50% penalty. </li>
<li>2 pts for the Lab report.</li>
</ol>
<p>We reserve the rights to grade your Lab according to your report in any situation. You can make a request for grading your Lab just according to your report if you cannot submit a runnable code. But we can't ensure we will give you any grade. </p>
<p>We may also grade your assignment just according to your report (which means we will give up your grade in autograder) if we find any <strong>SENSITIVE</strong> code in your work or we find some unmatched performance for you between the labs and lectures. To avoid this case, understand and following the instruction well, write the code by yourself and never share your code with others. </p>
<h2 id="what-to-write-in-report">What to write in report</h2>
<p>We don't expect a very detailed report. Keep it in 2-3 pages. You don't need to copy, paste and explain your code in the report, as we can find them in your repo. </p>
<p>Instead, you need to explain</p>
<ol>
<li>Which files you modified and the reason for the modification. </li>
<li>Is there any difficulty you met and how do you solve them.</li>
<li>Why is <code>p-&gt;lock</code> required when accessing the fields like <code>priority</code>, <code>burst time</code> etc. in the scheduler?</li>
<li>How do you deal with the <code>locks</code> in your scheduler. (<em>1 report pts</em>)</li>
<li>Where do you add the logic for aging and the reason for this. (<em>1 report pts</em>)</li>
<li>Are there any disadvantages for our time-sliced priority-based scheduler. If so, what are they and are there any methods to improve them? Otherwise explain why you think it's perfect. </li>
</ol>
<p>You can add other things in the report as well if you like. </p>
<h2 id="test-program">Test Program</h2>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel/types.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;user/user.h&quot;</span>

<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Q3Jvc3NpbmcgdGhlIHJpdmVyIGJ5IGZlZWxpbmcgdGhlIHN0b25lcw==&quot;</span><span class="p">;</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">srand</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">lcg_rand</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1103515245</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">107</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">seed</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">test_priority_setter_getter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_priority_setter_getter====================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_priority_setter_getter] setting self&#39;s priority to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">setpriority</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getpriority</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_priority_setter_getter] setpriority(0) failed, expected getpriority(0) == 0, got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpriority</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_priority_setter_getter] getpriority(0)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpriority</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lcg_rand</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_priority_setter_getter] setting self&#39;s priority to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">priority</span><span class="p">);</span>
<span class="w">    </span><span class="n">setpriority</span><span class="p">(</span><span class="n">priority</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getpriority</span><span class="p">(</span><span class="n">getpid</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">priority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_priority_setter_getter] setpriority(%d) failed, expected getpriority(%d) == %d, got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">priority</span><span class="p">,</span><span class="w"> </span><span class="n">priority</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="n">getpriority</span><span class="p">(</span><span class="n">getpid</span><span class="p">()));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_priority_setter_getter] getpriority(%d)=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="n">getpriority</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_priority_setter_getter] %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">test_wait_and_get_ticks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_wait_and_get_ticks====================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sleep_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lcg_rand</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_wait_and_get_ticks] child process, pid: %d, sleep_time: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="n">sleep_time</span><span class="p">);</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">ticks</span><span class="p">,</span><span class="w"> </span><span class="n">turnaround_ticks</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">actual_pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wait_and_get_ticks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ticks</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">turnaround_ticks</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">actual_pid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_wait_and_get_ticks] expected pid %d, got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">actual_pid</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_wait_and_get_ticks] waited pid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">actual_pid</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_wait_and_get_ticks] expected status 0, got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_wait_and_get_ticks] status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_wait_and_get_ticks] ticks: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ticks</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_wait_and_get_ticks] turnaround_ticks: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">turnaround_ticks</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_wait_and_get_ticks] %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">test_scheduler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;test_scheduler====================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">childs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">prioritys</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">130</span><span class="p">,</span><span class="w"> </span><span class="mi">135</span><span class="p">,</span><span class="w"> </span><span class="mi">145</span><span class="p">};</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">final_priority</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="n">setpriority</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_scheduler] child process, pid: %d, priority: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="n">prioritys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="n">setpriority</span><span class="p">(</span><span class="n">prioritys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">170</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">final_priority</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getpriority</span><span class="p">(</span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">final_priority</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">prioritys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_scheduler] child process, pid: %d, final priority: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">final_priority</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">final_priority</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">177</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_scheduler] expected priority 177, got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">final_priority</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="c1">// return 1;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">kill</span><span class="p">(</span><span class="n">childs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_scheduler] total priority difference: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;[test_scheduler] %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">tests</span><span class="p">[])(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">test_priority_setter_getter</span><span class="p">,</span>
<span class="w">    </span><span class="n">test_wait_and_get_ticks</span><span class="p">,</span>
<span class="w">    </span><span class="n">test_scheduler</span>
<span class="p">};</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">all_tests</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tests</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tests</span><span class="p">[</span><span class="n">i</span><span class="p">]())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">srand</span><span class="p">(</span><span class="n">uptime</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">tests</span><span class="p">[</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])]();</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">all_tests</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>For test 3-<code>test_scheduler</code>, it doesn't mean your scheduler is correct when you pass this test. There is a desirable output for it, which is the final priority for each process is <code>177</code> and the total difference priority difference is <code>170</code>. However, these numbers are not absolute. You answer should be close to this answer but minor difference is also acceptable. </p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Zhaoqi Xiao. All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>